#!/bin/bash
# Ø³ÙƒØ±ÙŠÙ¾Øª ØªØ´ØºÙŠÙ„ Ù…Ø­Ø³Ù† Ù„Ø¨ÙˆØª Ø§Ù„Ø£Ù†ØµØ§Ø± Ø§Ù„Ù„Ù‡ Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„

echo "ðŸš€ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ø§Ù„Ø£Ù†ØµØ§Ø± Ø§Ù„Ù„Ù‡ Ø§Ù„ÙŠÙ…Ù†ÙŠ (Ù…Ø­Ø³Ù†)"
echo "============================================="

# ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Python
if ! command -v python3 &> /dev/null; then
    echo "âŒ Ø®Ø·Ø£: Python 3 ØºÙŠØ± Ù…Ø«Ø¨Øª"
    exit 1
fi

echo "âœ… Python Ù…ØªÙˆÙØ±: $(python3 --version)"

# ÙØ­Øµ ÙˆØ¬ÙˆØ¯ pip
if ! command -v pip3 &> /dev/null; then
    echo "âŒ Ø®Ø·Ø£: pip3 ØºÙŠØ± Ù…Ø«Ø¨Øª"
    exit 1
fi

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
echo "ðŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©..."
mkdir -p data logs temp
echo "âœ… Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø¬Ø§Ù‡Ø²Ø©"

# ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù .env
if [ ! -f .env ]; then
    echo "âŒ Ø®Ø·Ø£: Ù…Ù„Ù .env ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
    echo "ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù .env Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©"
    exit 1
fi

echo "âœ… Ù…Ù„Ù .env Ù…ÙˆØ¬ÙˆØ¯"

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
if [ ! -d "venv" ]; then
    echo "ðŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©..."
    python3 -m venv venv
fi

echo "ðŸ”§ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©..."
source venv/bin/activate

echo "ðŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª..."
pip install -r requirements.txt

# ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥ØµÙ„Ø§Ø­
echo ""
echo "ðŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥ØµÙ„Ø§Ø­..."
python3 test-fix.py

echo ""
read -p "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØªØŸ (y/n): " -n 1 -r
echo

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„"
    exit 0
fi

# Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©
echo "ðŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©..."
pkill -f "python3 main.py" 2>/dev/null || true

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
echo ""
echo "ðŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª..."
echo "================================================="
echo "ðŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: $(date)"
echo "ðŸ•’ Ø§Ù„ÙˆÙ‚Øª: $(date +%H:%M:%S)"
echo "ðŸ“ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„: $(pwd)"
echo "================================================="

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø³Ø¬Ù„Ø§Øª
python3 main.py 2>&1 | tee logs/bot_$(date +%Y%m%d_%H%M%S).log